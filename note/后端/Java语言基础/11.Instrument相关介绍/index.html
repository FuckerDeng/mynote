<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>笔记整理 | 笔记整理</title>
    <meta name="description" content="来源于网络和自己的笔记，算法，数据结构，Java，JUC，JVM，数学">
    <link rel="preload stylesheet" href="/mynote/assets/style.bf609b55.css" as="style">
    <script type="module" src="/mynote/assets/app.390e3e8c.js"></script>
    <link rel="preload" href="/mynote/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/mynote/assets/chunks/framework.c70c7723.js">
  <link rel="modulepreload" href="/mynote/assets/chunks/theme.66150576.js">
  <link rel="modulepreload" href="/mynote/assets/note_后端_Java语言基础_11.Instrument相关介绍_index.md.1827f612.lean.js">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-b2cf3e0b><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8616af1></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8616af1> Skip to content </a><!--]--><!----><header class="VPNav" data-v-b2cf3e0b data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-94c81dcc><div class="container" data-v-94c81dcc><div class="title" data-v-94c81dcc><div class="VPNavBarTitle has-sidebar" data-v-94c81dcc data-v-f4ef19a3><a class="title" href="/mynote/" data-v-f4ef19a3><!--[--><!--]--><!--[--><img class="VPImage logo" src="https://developer.mozilla.org/favicon-48x48.cbbd161b.png" alt data-v-6db2186b><!--]--><!--[-->我的笔记整理<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-94c81dcc><div class="curtain" data-v-94c81dcc></div><div class="content-body" data-v-94c81dcc><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-94c81dcc><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-94c81dcc data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-94c81dcc data-v-f6a63727><label title="toggle dark mode" data-v-f6a63727 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-94c81dcc data-v-40855f84 data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-764effdf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-764effdf><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><label title="toggle dark mode" data-v-40855f84 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-94c81dcc data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-b2cf3e0b data-v-59bd7401><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-59bd7401><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-59bd7401><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-59bd7401>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-59bd7401 data-v-079b16a8><button data-v-079b16a8>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-b2cf3e0b data-v-af16598e><div class="curtain" data-v-af16598e></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af16598e><span class="visually-hidden" id="sidebar-aria-label" data-v-af16598e> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-af16598e><section class="VPSidebarItem level-0" data-v-af16598e data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>首页</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>linux</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/linux/keepalived/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>keepalived</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/linux/基础知识/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>基础知识</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/linux/容器技术/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>容器技术</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible has-active" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>后端</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java日志系统/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Java日志系统</p><!--]--><!----></a><!----></div><!----></div><section class="VPSidebarItem level-1 collapsible has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h3 class="text" data-v-c4656e6d>Java语言基础</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/01.基础语法/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>01.基础语法</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/02.面向对象/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>02.面向对象</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/03.高级语法/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>03.高级语法</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/04.常用模块/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>04.常用模块</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/05.各版本特性/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>05.各版本特性</p><!--]--><!----></a><!----></div><!----></div><section class="VPSidebarItem level-2 collapsible collapsed" data-v-c4656e6d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h4 class="text" data-v-c4656e6d>06.并发编程及JUC</h4><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-3 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/06.并发编程及JUC/1.线程共享模型/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>1.线程共享模型</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-3 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/06.并发编程及JUC/2.模式/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>2.模式</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-3 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/06.并发编程及JUC/3.应用/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>3.应用</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-3 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/06.并发编程及JUC/4.原理/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>4.原理</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-3 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/06.并发编程及JUC/5.volatile的性能分析/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>5.volatile的性能分析</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/07.jvm/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>07.jvm</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/08.字节码动态代码/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>08.字节码动态代码</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/09.常用监控工具/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>09.常用监控工具</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/10.代码热更新/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>10.代码热更新</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link is-active has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/Java语言基础/11.Instrument相关介绍/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>11.Instrument相关介绍</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/后端/nginx/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>nginx</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0" data-v-af16598e data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/当前紧迫的技术清单/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>当前紧迫的技术清单</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>数学</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数学/数理统计/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>数理统计</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数学/概率论/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>概率论</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数学/离散数学/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>离散数学</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数学/线性代数/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>线性代数</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数学/逻辑学/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>逻辑学</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数学/高等数学/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>高等数学</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>数据库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数据库/mongo/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>mongo</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数据库/mysql/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>mysql</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/数据库/redis/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>redis</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0" data-v-af16598e data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/方法论/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>方法论</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/杂/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>杂</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>编程基础</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/UML/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>UML</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/数据库原理/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>数据库原理</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/数据结构与算法/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>数据结构与算法</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/编译原理/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>编译原理</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/计算机系统结构/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>计算机系统结构</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/计算机组成/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>计算机组成</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/计算机网络/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>计算机网络</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/编程基础/设计模式/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>设计模式</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0" data-v-af16598e data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/美术/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>美术</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>脚本语言</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/脚本语言/groovy/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>groovy</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/脚本语言/lua/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>lua</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/脚本语言/python/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>python</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>英语</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/英语/词根-词缀记忆/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>词根-词缀记忆</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/mynote/note/英语/语法/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>语法</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-b2cf3e0b data-v-a494bd1d><div class="VPDoc has-sidebar has-aside" data-v-a494bd1d data-v-c4b0d3cf><!--[--><!--]--><div class="container" data-v-c4b0d3cf><div class="aside" data-v-c4b0d3cf><div class="aside-curtain" data-v-c4b0d3cf></div><div class="aside-container" data-v-c4b0d3cf><div class="aside-content" data-v-c4b0d3cf><div class="VPDocAside" data-v-c4b0d3cf data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-3f215769 data-v-ff0f39c8><div class="content" data-v-ff0f39c8><div class="outline-marker" data-v-ff0f39c8></div><div class="outline-title" data-v-ff0f39c8>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-ff0f39c8><span class="visually-hidden" id="doc-outline-aria-label" data-v-ff0f39c8> Table of Contents for current page </span><ul class="root" data-v-ff0f39c8 data-v-9a431c33><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c4b0d3cf><div class="content-container" data-v-c4b0d3cf><!--[--><!--]--><!----><main class="main" data-v-c4b0d3cf><div style="position:relative;" class="vp-doc _mynote_note_%E5%90%8E%E7%AB%AF_Java%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80_11_Instrument%E7%9B%B8%E5%85%B3%E4%BB%8B%E7%BB%8D_index" data-v-c4b0d3cf><div><p>参考：<a href="https://juejin.cn/post/7157684112122183693" target="_blank" rel="noreferrer">https://juejin.cn/post/7157684112122183693</a></p><h2 id="_1-instrumentation-api-介绍" tabindex="-1">1.Instrumentation API 介绍 <a class="header-anchor" href="#_1-instrumentation-api-介绍" aria-label="Permalink to &quot;1.Instrumentation API 介绍&quot;">​</a></h2><p>Instrumentation是Java提供的JVM接口，该接口提供了一系列查看和操作Java类定义的方法，例如修改类的字节码、向 classLoader 的 classpath 下加入jar文件等。使得开发者可以通过Java语言来操作和监控JVM内部的一些状态，进而实现Java程序的监控分析，甚至实现一些特殊功能（如AOP、热部署）。</p><p>Instrumentation的一些主要方法如下：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Instrumentation</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 注册一个Transformer，从此之后的类加载都会被Transformer拦截。</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * Transformer可以直接对类的字节码byte[]进行修改</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">addTransformer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ClassFileTransformer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">transformer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 对JVM已经加载的类重新触发类加载。使用的就是上面注册的Transformer。</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * retransformClasses可以修改方法体，但是不能变更方法签名、增加和删除方法/类的成员属性</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">retransformClasses</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Class</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#89DDFF;">&gt;...</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">classes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">UnmodifiableClassException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 获取一个对象的大小</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getObjectSize</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">objectToSize</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 将一个jar加入到bootstrap classloader的 classpath里</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">appendToBootstrapClassLoaderSearch</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">JarFile</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">jarfile</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 获取当前被JVM加载的所有类对象</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Class</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getAllLoadedClasses</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>addTransformer方法配置之后，后续的类加载都会被Transformer拦截。</p><p>对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</p><h2 id="_2-instrumentation的局限性" tabindex="-1">2.Instrumentation的局限性 <a class="header-anchor" href="#_2-instrumentation的局限性" aria-label="Permalink to &quot;2.Instrumentation的局限性&quot;">​</a></h2><p>在运行时，我们可以通过Instrumentation的redefineClasses方法进行类重定义，在redefineClasses方法上有一段注释需要特别注意：</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">* The redefinition may change method bodies, the constant pool and attributes.</span></span>
<span class="line"><span style="color:#A6ACCD;">     * The redefinition must not add, remove or rename fields or methods, change the</span></span>
<span class="line"><span style="color:#A6ACCD;">     * signatures of methods, or change inheritance.  These restrictions maybe be</span></span>
<span class="line"><span style="color:#A6ACCD;">     * lifted in future versions.  The class file bytes are not checked, verified and installed</span></span>
<span class="line"><span style="color:#A6ACCD;">     * until after the transformations have been applied, if the resultant bytes are in</span></span>
<span class="line"><span style="color:#A6ACCD;">     * error this method will throw an exception.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里面提到，我们不可以增加、删除或者重命名字段和方法，改变方法的签名或者类的继承关系。认识到这一点很重要，当我们通过ASM获取到增强的字节码之后，如果增强后的字节码没有遵守这些规则，那么调用redefineClasses方法来进行类的重定义就会失败。</p><h2 id="_3-java-agent" tabindex="-1">3.Java agent <a class="header-anchor" href="#_3-java-agent" aria-label="Permalink to &quot;3.Java agent&quot;">​</a></h2><p>主流的JVM都提供了Instrumentation的实现，但是鉴于Instrumentation的特殊功能，并不适合直接提供在JDK的runtime里，而更适合出现在Java程序的外层，以上帝视角在合适的时机出现。</p><p>因此如果想使用Instrumentation功能，拿到Instrumentation实例，我们必须通过Java agent。</p><p>Java agent是一种特殊的Java程序（Jar文件），它是Instrumentation的客户端。与普通Java程序通过main方法启动不同，agent 并不是一个可以单独启动的程序，而必须依附在一个Java应用程序（JVM）上，与它运行在同一个进程中，通过Instrumentation API与虚拟机交互。 Java agent与Instrumentation密不可分，二者也需要在一起使用。因为Instrumentation的实例会作为参数注入到Java agent的启动方法中。</p><h3 id="_3-1-java-agent-的格式" tabindex="-1">3.1 Java agent 的格式 <a class="header-anchor" href="#_3-1-java-agent-的格式" aria-label="Permalink to &quot;3.1 Java agent 的格式&quot;">​</a></h3><blockquote><p>premain和agentmain Java agent以jar包的形式部署在JVM中，jar文件的manifest需要指定agent的类名。根据不同的启动时机，agent类需要实现不同的方法（二选一）。 (1) JVM 启动时加载</p></blockquote><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> public static void premain</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">agentArgs,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Instrumentation</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">inst</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> public static void premain</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">agentArgs</span><span style="color:#89DDFF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>JVM将首先寻找[1]，如果没有发现[1]，再寻找[2]。 (2) JVM 运行时加载</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> public static void agentmain</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">agentArgs,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Instrumentation</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">inst</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> public static void agentmain</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">agentArgs</span><span style="color:#89DDFF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>与 premain()一致，JVM将首先寻找[1]，如果没有发现[1]，再寻找[2]。</p><blockquote><p>指定MANIFEST.MF 可以通过maven plugin配置，示例：</p></blockquote><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">&lt;!-- 设置manifest配置文件--&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">manifestEntries</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">&lt;!--Premain-Class: 代表 Agent 静态加载时会调用的类全路径名。--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">Premain-Class</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">demo.MethodAgentMain</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">Premain-Class</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">&lt;!--Agent-Class: 代表 Agent 动态加载时会调用的类全路径名。--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">Agent-Class</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">demo.MethodAgentMain</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">Agent-Class</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">&lt;!--Can-Redefine-Classes: 是否可进行类定义。--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">Can-Redefine-Classes</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">true</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">Can-Redefine-Classes</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">&lt;!--Can-Retransform-Classes: 是否可进行类转换。--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">Can-Retransform-Classes</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">true</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">Can-Retransform-Classes</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">manifestEntries</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>生成的MANIFEST.MF，示例：</p><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Premain-Class: demo.MethodAgentMain</span></span>
<span class="line"><span style="color:#A6ACCD;">Built-By: terry</span></span>
<span class="line"><span style="color:#A6ACCD;">Agent-Class: demo.MethodAgentMain</span></span>
<span class="line"><span style="color:#A6ACCD;">Can-Redefine-Classes: true</span></span>
<span class="line"><span style="color:#A6ACCD;">Can-Retransform-Classes: true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-2-java-agent-的加载" tabindex="-1">3.2 Java agent 的加载 <a class="header-anchor" href="#_3-2-java-agent-的加载" aria-label="Permalink to &quot;3.2 Java agent 的加载&quot;">​</a></h3><blockquote><p>Java agent 与 ClassLoader Java agent 的包先会被加入到 system class path 中，然后 agent 的类会被system calss loader(默认AppClassLoader)所加载，和应用代码的真实classLoader无关。例如：当启动参数加上-javaagent:my-agent.jar运行 SpringBoot 打包的 fatjar 时，fatjar 中应用代码和 lib 中嵌套 jar 是由 org.springframework.boot.loader.LaunchedURLClassLoader 加载，但这个 my-agent.jar 依然是在system calss loader(默认AppClassLoader)中加载，而非 org.springframework.boot.loader.LaunchedURLClassLoader 加载。</p></blockquote><p>该类加载逻辑非常重要，在使用 Java agent 时如果遇到ClassNotFoundException、NoClassDefFoundError，很大可能就是与该加载逻辑有关。</p><blockquote><p>静态加载、动态加载 Java agent Java agent 支持静态加载和动态加载。</p></blockquote><h4 id="_3-2-1-静态加载-java-agent" tabindex="-1">3.2.1 静态加载 Java agent <a class="header-anchor" href="#_3-2-1-静态加载-java-agent" aria-label="Permalink to &quot;3.2.1 静态加载 Java agent&quot;">​</a></h4><p>静态加载，即 JVM 启动时加载，对应的是 premain() 方法。通过 vm 启动参数-javaagent将 agent jar 挂载到目标 JVM 程序，随目标 JVM 程序一起启动。</p><p>(1) -javaagent启动参数 其中 -javaagent格式： &quot;-javaagent:jarpath(option)&quot;。(option)部分可以指定 agent 的参数，可以传递到premain(String agentArgs, Instrumentation inst)方法的agentArgs入参中。支持可以定义多个agent，按指定顺序先后执行。</p><p>示例: java -javaagent:agent1.jar=key1=value1&amp;key2=value2 -javaagent:agent2.jar -jar Test.jar</p><ul><li>其中加载顺序为(1) agent1.jar (2) agent2.jar。</li></ul><p><strong>注意：不同的顺序可能会导致 agent 对类的修改存在冲突，在实际项目中用到了pinpoint和SkyWalking的agent，当通过-javaagent先挂载 pinpoint的 agent ，后挂载 SkyWalking</strong>的 agent，出现 SkyWalking对类的增强发生异常的情况，而先挂载SkyWalking的 agent 则无问题。</p><ul><li>agent1.jar 的premain(String agentArgs, Instrumentation inst)方法的agentArgs值为key1=value1&amp;key2=value2。</li></ul><p>(2) premain()方法</p><p>premain()方法会在程序main方法执行之前被调用，此时大部分Java类都没有被加载（&quot;大部分&quot;是因为，agent类本身和它依赖的类还是无法避免的会先加载的），是一个对类加载埋点做手脚（addTransformer）的好机会。</p><p>如果此时premain方法执行失败或抛出异常，那么JVM的启动会被终止。</p><p>premain() 中一般会编写如下步骤：</p><p>注册类的 ClassFileTransformer，在类加载的时候会自动更新对应的类的字节码 写法示例：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// Java agent指定的premain方法，会在main方法之前被调用</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">premain</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Instrumentation</span><span style="color:#A6ACCD;"> inst</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Instrumentation提供的addTransformer方法，在类加载时会回调ClassFileTransformer接口</span></span>
<span class="line"><span style="color:#A6ACCD;">    inst</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addTransformer</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ClassFileTransformer</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">loader</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">className</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Class</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">classBeingRedefined</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#C792EA;">ProtectionDomain</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">protectionDomain</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">classfileBuffer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// TODO 字节码修改</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> transformed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> transformed</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>(3) 静态加载执行流程 agent 中的 class 由 system calss loader(默认AppClassLoader) 加载，premain() 方法会调用 Instrumentation API，然后 Instrumentation API 调用 JVMTI(JVMTI的内容将在后面补充)，在需要加载的类需要被加载时，会回调 JVMTI，然后回调 Instrumentation API，触发ClassFileTransformer.transform()，最终修改 class 的字节码。</p><p><img src="/mynote/assets/screenshot-20230525-181611.3dee9e4f.png" alt="静态加载执行流程"></p><p>(4) ClassFileTransformer.transform() ClassFileTransformer.transform() 和 ClassLoader.load()的关系 下面是一次 ClassFileTransformer.transform()执行时的方法调用栈，</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">transform</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">38</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MethodAgentMain$1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">demo</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">transform</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">188</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TransformerManager</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">instrument</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">transform</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">428</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">InstrumentationImpl</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">instrument</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">defineClass1</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lang</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">defineClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">760</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lang</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">defineClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">142</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SecureClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">security</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">defineClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">467</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">URLClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">access$100</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">73</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">URLClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">run</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">368</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">URLClassLoader$1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">run</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">362</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">URLClassLoader$1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">doPrivileged</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AccessController</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">security</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">findClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">361</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">URLClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">loadClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">424</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lang</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">loadClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">331</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Launcher$AppClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">misc</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">loadClass</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">357</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ClassLoader</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">java</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lang</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">checkAndLoadMain</span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#F78C6C;">495</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LauncherHelper</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">launcher</span><span style="color:#89DDFF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>可以看到 ClassLoader.load()加载类时，ClassLoader.load()会调用ClassLoader.findClass(),ClassLoader.findClass()会调用ClassLoader.defefineClass()，ClassLoader.defefineClass()最终会执行ClassFileTransformer.transform() ，ClassFileTransformer.transform() 可以对类进行修改。所以ClassLoader.load()最终加载 agent 修改后Class对象。 下面是精简后的 ClassLoader.load() 核心代码：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Class</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;font-style:italic;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loadClass</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> resolve</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    throws </span><span style="color:#C792EA;">ClassNotFoundException</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">synchronized</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getClassLoadingLock</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 判断是否已经加载过了，如果没有，则进行load</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// First, check if the class has already been loaded</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Class</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">findLoadedClass</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">// If still not found, then invoke findClass in order</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">// to find the class.</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> t1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">nanoTime</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">// findClass()内部最终会调用 Java agent 中 ClassFileTransformer.transform()</span></span>
<span class="line"><span style="color:#A6ACCD;">                c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">findClass</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">// this is the defining class loader; record the stats</span></span>
<span class="line"><span style="color:#A6ACCD;">                sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">misc</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PerfCounter</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getParentDelegationTime</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">addTime</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t1 </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> t0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">misc</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PerfCounter</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getFindClassTime</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">addElapsedTimeFrom</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                sun</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">misc</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PerfCounter</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getFindClasses</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">increment</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">resolve</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">resolveClass</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> c</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>ClassFileTransformer.transform() 和 字节码增强 ClassFileTransformer.transform() 中可以对指定的类进行增强，我们可以选择的代码生成库修改字节码对类进行增强，比如ASM, CGLIB, Byte Buddy, Javassist。</p><h4 id="_3-2-2-动态加载-java-agent" tabindex="-1">3.2.2 动态加载 Java agent <a class="header-anchor" href="#_3-2-2-动态加载-java-agent" aria-label="Permalink to &quot;3.2.2  动态加载 Java agent&quot;">​</a></h4><p>静态加载，即 JVM 启动后的任意时间点(即运行时)，通过Attach API动态地加载 Java agent，对应的是 agentmain() 方法。 Attach API部分将在后面的章节进行说明。 agentmain()方法 对于VM启动后加载的Java agent，其agentmain()方法会在加载之时立即执行。如果agentmain执行失败或抛出异常，JVM会忽略掉错误，不会影响到正在 running 的 Java 程序。 一般 agentmain() 中会编写如下步骤：</p><ul><li>注册类的 ClassFileTransformer</li><li>调用 retransformClasses 方法对指定的类进行重加载</li></ul><h3 id="jvmti" tabindex="-1">JVMTI <a class="header-anchor" href="#jvmti" aria-label="Permalink to &quot;JVMTI&quot;">​</a></h3><h4 id="_1-jvmti-介绍" tabindex="-1">1 JVMTI 介绍 <a class="header-anchor" href="#_1-jvmti-介绍" aria-label="Permalink to &quot;1 JVMTI 介绍&quot;">​</a></h4><p>JVMTI （JVM Tool Interface）是 Java 虚拟机对外提供的 Native 编程接口，通过 JVMTI ，外部进程可以获取到运行时JVM的诸多信息，比如线程、GC等。 JVMTI 是一套 Native 接口，在 Java SE 5 之前，要实现一个 Agent 只能通过编写 Native 代码来实现。从 Java SE 5 开始，可以使用 Java 的Instrumentation 接口（java.lang.instrument）来编写 Agent。无论是通过 Native 的方式还是通过 Java Instrumentation 接口的方式来编写 Agent，它们的工作都是借助 JVMTI 来进行完成。</p><p>启动方式</p><p>JVMTI和Instumentation API的作用很相似，都是一套 JVM 操作和监控的接口，且都需要通过agent来启动：</p><ul><li>Instumentation API需要打包成 jar，并通过 Java agent 加载（对应启动参数: -javaagent）</li><li>JVMTI 需要打包成动态链接库（随操作系统，如.dll/.so文件），并通过 JVMTI agent 加载（对应启动参数: -agentlib/-agentpath）</li></ul><h4 id="_2-加载时机" tabindex="-1">2 加载时机 <a class="header-anchor" href="#_2-加载时机" aria-label="Permalink to &quot;2 加载时机&quot;">​</a></h4><p>启动时（Agent_OnLoad）和运行时Attach（Agent_OnAttach）</p><h4 id="_3-功能" tabindex="-1">3 功能 <a class="header-anchor" href="#_3-功能" aria-label="Permalink to &quot;3 功能&quot;">​</a></h4><p>Instumentation API 可以支持 Java 语言实现 agent 功能，但是 JVMTI 功能比 Instumentation API 更强大，它支持：</p><ul><li>获取所有线程、查看线程状态、线程调用栈、查看线程组、中断线程、查看线程持有和等待的锁、获取线程的CPU时间、甚至将一个运行中的方法强制返回值……</li><li>获取Class、Method、Field的各种信息，类的详细信息、方法体的字节码和行号、向Bootstrap/System Class Loader添加jar、修改System Property……</li><li>堆内存的遍历和对象获取、获取局部变量的值、监测成员变量的值……</li><li>各种事件的callback函数，事件包括：类文件加载、异常产生与捕获、线程启动和结束、进入和退出临界区、成员变量修改、gc开始和结束、方法调用进入和退出、临界区竞争与等待、VM启动与退出……</li><li>设置与取消断点、监听断点进入事件、单步执行事件……</li></ul><h4 id="_4-jvmti-与-java-agent" tabindex="-1">4 JVMTI 与 Java agent <a class="header-anchor" href="#_4-jvmti-与-java-agent" aria-label="Permalink to &quot;4  JVMTI 与 Java agent&quot;">​</a></h4><p>Java agent 是基于 JVMTI 实现，核心部分是 ClassFileLoadHook和TransFormClassFile。</p><p>ClassFileLoadHook是一个 JVMTI 事件，该事件是 Instrumentation agent 的一个核心事件，主要是在读取字节码文件回调时调用，内部调用了TransFormClassFile的函数。</p><p>TransFormClassFile的主要作用是调用java.lang.instrument.ClassFileTransformer的tranform方法，该方法由开发者实现，通过Instrumentation的addTransformer方法进行注册。</p><p>在字节码文件加载的时候，会触发ClassFileLoadHook事件，该事件调用TransFormClassFile，通过经由Instrumentation 的 addTransformer 注册的方法完成整体的字节码修改。</p><p>对于已加载的类，需要调用retransformClass函数，然后经由redefineClasses函数，在读取已加载的字节码文件后，若该字节码文件对应的类关注了ClassFileLoadHook事件，则调用ClassFileLoadHook事件。后续流程与类加载时字节码替换一致。</p><h3 id="attach-api" tabindex="-1">Attach API <a class="header-anchor" href="#attach-api" aria-label="Permalink to &quot;Attach API&quot;">​</a></h3><p>前文提到，Java agent 动态加载是通过 Attach API 实现。</p><h4 id="_1-attach-api-介绍" tabindex="-1">1 Attach API 介绍 <a class="header-anchor" href="#_1-attach-api-介绍" aria-label="Permalink to &quot;1 Attach API 介绍&quot;">​</a></h4><p>Attach机制是JVM提供一种JVM进程间通信的能力，能让一个进程传命令给另外一个进程，并让它执行内部的一些操作。 日常很多工作都是通过 Attach API 实现的，示例：</p><ul><li>JDK 自带的一些命令，如：jstack打印线程栈、jps列出Java进程、jmap做内存dump等功能</li><li>Arthas、Greys、btrace 等监控诊断产品，通过 attach 目标 JVM 进程发送指定命令，可以实现方法调用等方面的监控。</li></ul><h4 id="_2-attach-api-用法" tabindex="-1">2 Attach API 用法 <a class="header-anchor" href="#_2-attach-api-用法" aria-label="Permalink to &quot;2 Attach API 用法&quot;">​</a></h4><p>由于是进程间通讯，那代表着使用Attach API的程序需要是一个独立的Java程序，通过attach目标进程，与其进行通讯。下面的代码表示了向进程pid为1234的JVM发起通讯，加载一个名为agent.jar的Java agent。</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// VirtualMachine等相关Class位于JDK的tools.jar</span></span>
<span class="line"><span style="color:#C792EA;">VirtualMachine</span><span style="color:#A6ACCD;"> vm </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> VirtualMachine</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">attach</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1234</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">// 1234表示目标JVM进程pid</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    vm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">loadAgent</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.../javaagent.jar</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// 指定agent的jar包路径，发送给目标进程</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// attach 动作的相反的行为，从 JVM 上面解除一个代理  </span></span>
<span class="line"><span style="color:#A6ACCD;">    vm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">detach</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>vm.loadAgent 之后，相应的 agent 就会被目标 JVM 进程加载，并执行 agentmain() 方法。</p><p>执行的流程图：</p><p><img src="/mynote/assets/screenshot-20230525-182447.8daee826.png" alt="执行流程"></p><h4 id="_3-attach-api-原理" tabindex="-1">3 Attach API 原理 <a class="header-anchor" href="#_3-attach-api-原理" aria-label="Permalink to &quot;3 Attach API 原理&quot;">​</a></h4><p>以Hotspot虚拟机，Linux系统为例。当external process(attach发起的进程)执行VirtualMachine.attach时，需要通过操作系统提供的进程通信方法，例如信号、socket，进行握手和通信。其具体内部实现流程如下所示：</p><p><img src="/mynote/assets/screenshot-20230525-182545.4b0b29b6.png" alt="执行流程"></p><p>上面提到了两个文件：</p><ul><li>.attach_pidXXX 后面的XXX代表pid，例如pid为1234则文件名为.attach_pid1234。该文件目的是给目标JVM一个标记，表示触发SIGQUIT信号的是attach请求。这样目标JVM才可以把SIGQUIT信号当做attach连接请求，再来做初始化。其默认全路径为/proc/XXX/cwd/.attach_pidXXX，若创建失败则使用/tmp/attach_pidXXX</li><li>.java_pidXXX 后面的XXX代表pid，例如pid为1234则文件名为.java_pid1234。由于Unix domain socket通讯是基于文件的，该文件就是表示external process与target VM进行socket通信所使用的文件，如果存在说明目标JVM已经做好连接准备。其默认全路径为/proc/XXX/cwd/.java_pidXXX，若创建失败则使用/tmp/java_pidXXX</li></ul><p>VirtualMachine.attach动作类似TCP创建连接的三次握手，目的就是搭建attach通信的连接。而后面执行的操作，例如vm.loadAgent，其实就是向这个socket写入数据流，接收方target VM会针对不同的传入数据来做不同的处理。</p></div></div></main><footer class="VPDocFooter" data-v-c4b0d3cf data-v-face870a><!--[--><!--]--><div class="edit-info" data-v-face870a><!----><div class="last-updated" data-v-face870a><p class="VPLastUpdated" data-v-face870a data-v-7b3ebfe1>Last updated: <time datetime="2023-06-01T10:29:32.000Z" data-v-7b3ebfe1></time></p></div></div><div class="prev-next" data-v-face870a><div class="pager" data-v-face870a><a class="pager-link prev" href="/mynote/note/后端/Java语言基础/10.代码热更新/" data-v-face870a><span class="desc" data-v-face870a>Previous page</span><span class="title" data-v-face870a>10.代码热更新</span></a></div><div class="has-prev pager" data-v-face870a><a class="pager-link next" href="/mynote/note/后端/nginx/" data-v-face870a><span class="desc" data-v-face870a>Next page</span><span class="title" data-v-face870a>nginx</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"note_linux_基础知识_index.md\":\"9dbad28a\",\"note_linux_容器技术_index.md\":\"7eed8798\",\"index.md\":\"ac26ca89\",\"note_工具_持续集成_jenkins.md\":\"e8b8764b\",\"note_数学_逻辑学_index.md\":\"949a80c3\",\"note_数学_高等数学_index.md\":\"c5c998ec\",\"note_数据库_mongo_index.md\":\"24963621\",\"note_数据库_mysql_index.md\":\"4053a2bd\",\"note_数据库_redis_index.md\":\"f3d05f8c\",\"note_方法论_index.md\":\"bf9e5518\",\"note_当前紧迫的技术清单_index.md\":\"95ecb5a0\",\"note_杂_index.md\":\"ff37ad39\",\"note_数学_数理统计_index.md\":\"0081df2f\",\"note_编程基础_uml_index.md\":\"da259604\",\"note_数学_概率论_index.md\":\"32565e58\",\"note_编程基础_数据库原理_index.md\":\"5a90b089\",\"note_编程基础_数据结构与算法_index.md\":\"6063cf4a\",\"note_数学_离散数学_index.md\":\"88ddac7f\",\"note_编程基础_编译原理_index.md\":\"1346ffb3\",\"note_数学_线性代数_index.md\":\"13aa99be\",\"note_编程基础_计算机组成_index.md\":\"ae455a5b\",\"note_编程基础_计算机系统结构_index.md\":\"10156a33\",\"note_编程基础_计算机网络_index.md\":\"2a26d90e\",\"note_编程基础_设计模式_index.md\":\"8bb7f6c3\",\"note_美术_index.md\":\"e863e9d3\",\"note_脚本语言_lua_index.md\":\"7f74e6da\",\"note_英语_语法_index.md\":\"527f7323\",\"note_脚本语言_groovy_index.md\":\"82c4ab47\",\"note_脚本语言_python_index.md\":\"b6db6b22\",\"note_后端_java日志系统_index.md\":\"4d6c2045\",\"note_后端_java语言基础_06.并发编程及juc_2.模式_index.md\":\"3bc0e312\",\"note_linux_keepalived_index.md\":\"d7b851d4\",\"note_后端_java语言基础_06.并发编程及juc_3.应用_index.md\":\"c641caa5\",\"note_后端_java语言基础_06.并发编程及juc_5.volatile的性能分析_index.md\":\"060db62b\",\"note_后端_java语言基础_07.jvm_index.md\":\"ef8d8e24\",\"note_后端_java语言基础_08.字节码动态代码_index.md\":\"bfb26c4f\",\"note_后端_java语言基础_02.面向对象_index.md\":\"de2442a0\",\"note_后端_java语言基础_01.基础语法_index.md\":\"3980de8c\",\"note_英语_词根-词缀记忆_index.md\":\"b590e7ad\",\"note_后端_java语言基础_04.常用模块_index.md\":\"9c8fbb8f\",\"note_后端_java语言基础_05.各版本特性_index.md\":\"1a64ebc5\",\"note_后端_java语言基础_09.常用监控工具_index.md\":\"5015d149\",\"note_后端_java语言基础_06.并发编程及juc_4.原理_index.md\":\"838784ec\",\"note_后端_java语言基础_03.高级语法_index.md\":\"c1ce9136\",\"note_后端_java语言基础_10.代码热更新_index.md\":\"ca4207a0\",\"note_后端_java语言基础_11.instrument相关介绍_index.md\":\"1827f612\",\"note_后端_nginx_index.md\":\"4fc2af8d\",\"note_后端_java语言基础_06.并发编程及juc_1.线程共享模型_index.md\":\"c54212f3\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"zh-cn\",\"dir\":\"ltr\",\"title\":\"笔记整理\",\"description\":\"来源于网络和自己的笔记，算法，数据结构，Java，JUC，JVM，数学\",\"base\":\"/mynote/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"https://developer.mozilla.org/favicon-48x48.cbbd161b.png\",\"siteTitle\":\"我的笔记整理\",\"nav\":[],\"sidebar\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"linux\",\"collapsed\":true,\"items\":[{\"text\":\"keepalived\",\"link\":\"/note/linux/keepalived/\"},{\"text\":\"基础知识\",\"link\":\"/note/linux/基础知识/\"},{\"text\":\"容器技术\",\"link\":\"/note/linux/容器技术/\"}]},{\"text\":\"后端\",\"collapsed\":true,\"items\":[{\"text\":\"Java日志系统\",\"link\":\"/note/后端/Java日志系统/\"},{\"text\":\"Java语言基础\",\"collapsed\":true,\"items\":[{\"text\":\"01.基础语法\",\"link\":\"/note/后端/Java语言基础/01.基础语法/\"},{\"text\":\"02.面向对象\",\"link\":\"/note/后端/Java语言基础/02.面向对象/\"},{\"text\":\"03.高级语法\",\"link\":\"/note/后端/Java语言基础/03.高级语法/\"},{\"text\":\"04.常用模块\",\"link\":\"/note/后端/Java语言基础/04.常用模块/\"},{\"text\":\"05.各版本特性\",\"link\":\"/note/后端/Java语言基础/05.各版本特性/\"},{\"text\":\"06.并发编程及JUC\",\"collapsed\":true,\"items\":[{\"text\":\"1.线程共享模型\",\"link\":\"/note/后端/Java语言基础/06.并发编程及JUC/1.线程共享模型/\"},{\"text\":\"2.模式\",\"link\":\"/note/后端/Java语言基础/06.并发编程及JUC/2.模式/\"},{\"text\":\"3.应用\",\"link\":\"/note/后端/Java语言基础/06.并发编程及JUC/3.应用/\"},{\"text\":\"4.原理\",\"link\":\"/note/后端/Java语言基础/06.并发编程及JUC/4.原理/\"},{\"text\":\"5.volatile的性能分析\",\"link\":\"/note/后端/Java语言基础/06.并发编程及JUC/5.volatile的性能分析/\"}]},{\"text\":\"07.jvm\",\"link\":\"/note/后端/Java语言基础/07.jvm/\"},{\"text\":\"08.字节码动态代码\",\"link\":\"/note/后端/Java语言基础/08.字节码动态代码/\"},{\"text\":\"09.常用监控工具\",\"link\":\"/note/后端/Java语言基础/09.常用监控工具/\"},{\"text\":\"10.代码热更新\",\"link\":\"/note/后端/Java语言基础/10.代码热更新/\"},{\"text\":\"11.Instrument相关介绍\",\"link\":\"/note/后端/Java语言基础/11.Instrument相关介绍/\"}]},{\"text\":\"nginx\",\"link\":\"/note/后端/nginx/\"}]},{\"text\":\"当前紧迫的技术清单\",\"link\":\"/note/当前紧迫的技术清单/\"},{\"text\":\"数学\",\"collapsed\":true,\"items\":[{\"text\":\"数理统计\",\"link\":\"/note/数学/数理统计/\"},{\"text\":\"概率论\",\"link\":\"/note/数学/概率论/\"},{\"text\":\"离散数学\",\"link\":\"/note/数学/离散数学/\"},{\"text\":\"线性代数\",\"link\":\"/note/数学/线性代数/\"},{\"text\":\"逻辑学\",\"link\":\"/note/数学/逻辑学/\"},{\"text\":\"高等数学\",\"link\":\"/note/数学/高等数学/\"}]},{\"text\":\"数据库\",\"collapsed\":true,\"items\":[{\"text\":\"mongo\",\"link\":\"/note/数据库/mongo/\"},{\"text\":\"mysql\",\"link\":\"/note/数据库/mysql/\"},{\"text\":\"redis\",\"link\":\"/note/数据库/redis/\"}]},{\"text\":\"方法论\",\"link\":\"/note/方法论/\"},{\"text\":\"杂\",\"link\":\"/note/杂/\"},{\"text\":\"编程基础\",\"collapsed\":true,\"items\":[{\"text\":\"UML\",\"link\":\"/note/编程基础/UML/\"},{\"text\":\"数据库原理\",\"link\":\"/note/编程基础/数据库原理/\"},{\"text\":\"数据结构与算法\",\"link\":\"/note/编程基础/数据结构与算法/\"},{\"text\":\"编译原理\",\"link\":\"/note/编程基础/编译原理/\"},{\"text\":\"计算机系统结构\",\"link\":\"/note/编程基础/计算机系统结构/\"},{\"text\":\"计算机组成\",\"link\":\"/note/编程基础/计算机组成/\"},{\"text\":\"计算机网络\",\"link\":\"/note/编程基础/计算机网络/\"},{\"text\":\"设计模式\",\"link\":\"/note/编程基础/设计模式/\"}]},{\"text\":\"美术\",\"link\":\"/note/美术/\"},{\"text\":\"脚本语言\",\"collapsed\":true,\"items\":[{\"text\":\"groovy\",\"link\":\"/note/脚本语言/groovy/\"},{\"text\":\"lua\",\"link\":\"/note/脚本语言/lua/\"},{\"text\":\"python\",\"link\":\"/note/脚本语言/python/\"}]},{\"text\":\"英语\",\"collapsed\":true,\"items\":[{\"text\":\"词根-词缀记忆\",\"link\":\"/note/英语/词根-词缀记忆/\"},{\"text\":\"语法\",\"link\":\"/note/英语/语法/\"}]}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>